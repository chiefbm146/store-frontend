<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="./js/clean-url.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat - Premium Goods Co.</title>

    <meta property="og:type" content="website">
    <meta property="og:title" content="AI Chat Assistant">
    <meta property="og:description" content="Chat with our AI assistant">

    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75'>ðŸ¤–</text></svg>">

    <!-- CSS -->
    <link rel="stylesheet" href="./css/ai-chat.css">
</head>
<body>
    <div class="chat-container">
        <!-- Header -->
        <div class="chat-header">
            <div class="chat-header-left">
                <a href="/demo-desk.html" class="back-arrow" title="Back to Store">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </a>
                <div>
                    <h1 class="chat-title">ðŸ¤– AI Chat Assistant</h1>
                    <p class="chat-subtitle">Ask me anything about our store!</p>
                </div>
            </div>
        </div>

        <!-- Messages Area -->
        <div class="messages-container" id="messagesContainer">
            <div id="welcomeMessage" class="welcome-message">
                <div class="welcome-icon">ðŸ¤–</div>
                <h2 class="welcome-title">Hi! I'm Your AI Assistant</h2>
                <p class="welcome-description">I'm here to help you with any questions about our products, services, or store. What would you like to know?</p>
                <div class="welcome-suggestions">
                    <button class="suggestion-button" onclick="sendSuggestion('Tell me about your products')">
                        Tell me about your products
                    </button>
                    <button class="suggestion-button" onclick="sendSuggestion('What services do you offer?')">
                        What services do you offer?
                    </button>
                    <button class="suggestion-button" onclick="sendSuggestion('How do I place an order?')">
                        How do I place an order?
                    </button>
                    <button class="suggestion-button" onclick="sendSuggestion('What are your hours?')">
                        What are your hours?
                    </button>
                </div>
            </div>

            <div class="messages" id="messages"></div>

            <div class="typing-indicator" id="typingIndicator">
                <span class="typing-dot"></span>
                <span class="typing-dot"></span>
                <span class="typing-dot"></span>
                <span class="typing-text">AI is typing...</span>
            </div>
        </div>

        <!-- Input Area -->
        <div class="input-area">
            <div class="input-wrapper">
                <input
                    type="text"
                    id="userInput"
                    placeholder="Type your message here..."
                    autocomplete="off"
                    maxlength="4000"
                />
                <button id="sendButton" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <!-- Config System -->
    <script type="module">
        import { injectTheme } from './js/theme-injector.js';

        // Inject theme
        injectTheme();
        console.log('[AI Chat] Theme injected');
    </script>

    <!-- Chat Functionality -->
    <script>
        // ========================================
        // CONFIGURATION
        // ========================================
        const BACKEND_URL = 'https://stores-backend-phhl2xgwwa-uc.a.run.app';
        const CHAT_ENDPOINT = '/chat';

        // Session management
        let SESSION_ID = null;
        let REQUEST_COUNT = 0;

        const messagesDiv = document.getElementById('messages');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const typingIndicator = document.getElementById('typingIndicator');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const messagesContainer = document.getElementById('messagesContainer');

        // Initialize session on page load
        function initializeSession() {
            // Generate or retrieve session ID
            SESSION_ID = sessionStorage.getItem('chat_session_id');
            if (!SESSION_ID) {
                SESSION_ID = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                sessionStorage.setItem('chat_session_id', SESSION_ID);
                console.log('[AI Chat] New session created:', SESSION_ID);
            } else {
                console.log('[AI Chat] Resuming session:', SESSION_ID);
            }
            REQUEST_COUNT = parseInt(sessionStorage.getItem('chat_request_count') || '0');
        }

        function scrollToTop() {
            messagesContainer.scrollTop = 0;
        }

        function hideWelcome() {
            if (welcomeMessage.style.display !== 'none') {
                welcomeMessage.style.display = 'none';
            }
        }

        function addMessage(text, isUser) {
            hideWelcome();

            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + (isUser ? 'user-message' : 'ai-message');
            messageDiv.textContent = text;
            messagesDiv.appendChild(messageDiv);

            scrollToTop();
        }

        function showTyping() {
            typingIndicator.classList.add('visible');
            scrollToTop();
        }

        function hideTyping() {
            typingIndicator.classList.remove('visible');
        }

        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            // Disable input while sending
            userInput.disabled = true;
            sendButton.disabled = true;

            // Clear previous messages - only show current exchange
            messagesDiv.innerHTML = '';
            hideWelcome();

            // Add user message
            addMessage(message, true);
            userInput.value = '';

            // Show typing indicator
            showTyping();

            try {
                REQUEST_COUNT++;
                sessionStorage.setItem('chat_request_count', REQUEST_COUNT.toString());

                const payload = {
                    session_id: SESSION_ID,
                    prompt: message,
                    device_fingerprint: 'store-frontend-' + navigator.userAgent.substring(0, 50)
                };

                console.log('[AI Chat] Sending request:', { ...payload, prompt: message.substring(0, 50) + '...' });

                const response = await fetch(BACKEND_URL + CHAT_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    hideTyping();
                    const errorText = await response.text();
                    console.error('[AI Chat] Backend error:', response.status, errorText);

                    let errorMessage = 'Sorry, I encountered an error connecting to the server.';
                    if (response.status === 429) {
                        errorMessage = 'Too many requests. Please wait a moment before trying again.';
                    } else if (response.status === 503) {
                        errorMessage = 'The service is temporarily unavailable. Please try again in a moment.';
                    }
                    addMessage(errorMessage, false);
                    return;
                }

                const data = await response.json();
                hideTyping();

                // Extract AI response
                const aiResponse = data.response || 'I received an empty response from the server.';
                console.log('[AI Chat] Received response:', aiResponse.substring(0, 100) + '...');

                addMessage(aiResponse, false);

            } catch (error) {
                hideTyping();
                console.error('[AI Chat] Fetch error:', error);

                let errorMessage = 'Sorry, I could not connect to the server. ';
                if (error instanceof TypeError) {
                    errorMessage += 'Check if the backend is running and CORS is enabled.';
                } else {
                    errorMessage += error.message;
                }
                addMessage(errorMessage, false);
            } finally {
                // Re-enable input
                userInput.disabled = false;
                sendButton.disabled = false;
                userInput.focus();
            }
        }

        function sendSuggestion(text) {
            userInput.value = text;
            sendMessage();
        }

        // Enter key to send
        userInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !userInput.disabled) {
                sendMessage();
            }
        });

        // Escape to go back
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                window.location.href = '/demo-desk.html';
            }
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeSession();
            userInput.focus();
            console.log('[AI Chat] Page loaded and initialized');
        });
    </script>
</body>
</html>
