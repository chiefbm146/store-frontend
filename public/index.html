<!-- CI/CD Pipeline Test: GitHub Actions Auto-Deploy Active -->
<!-- TEST -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moon Tide Reconciliation</title>

    <!-- Open Graph / Facebook Meta Tags (Router) -->
    <!-- VERSION: 11.0.12 - DO NOT MANUALLY EDIT - Updated by version-update.js -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://reconciliation-storefront.web.app/">
    <meta property="og:title" content="Moon Tide Reconciliation">
    <meta property="og:description" content="Moon Tide Reconciliation: Transformative workshops and Indigenous cultural experiences celebrating ancestral wisdom and reconciliation.">
    <meta property="og:image" content="https://reconciliation-storefront.web.app/images/musqueam/moon9.png">
    <meta property="og:image:width" content="794">
    <meta property="og:image:height" content="1123">
    <meta property="og:image:type" content="image/png">
    <meta property="og:site_name" content="Moon Tide Reconciliation">
    <meta property="og:updated_time" content="2025-11-12T20:00:00.000Z">

    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://reconciliation-storefront.web.app/">
    <meta name="twitter:title" content="Moon Tide Reconciliation">
    <meta name="twitter:description" content="Join transformative reconciliation workshops and explore Indigenous cultural wisdom at Moon Tide Reconciliation.">
    <meta name="twitter:image" content="https://reconciliation-storefront.web.app/images/musqueam/moon9.png">

    <!-- Additional Meta Tags -->
    <meta name="description" content="Moon Tide Reconciliation: Transformative workshops, cultural education, and Indigenous experiences celebrating ancestral wisdom.">
    <meta name="author" content="Moon Tide Reconciliation Collective">

    <!-- Ensure body takes up full viewport for intro loader -->
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <!-- CRITICAL: Include the device detector script -->
    <script src="./js/device-detector.js?v=11.0.12"></script>
    <script type="module">
        // Wait for DOM to be fully ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initAndRoute);
        } else {
            initAndRoute();
        }

        async function initAndRoute() {
            // Check if this is a known crawler/bot that needs OG meta tags
            const userAgent = navigator.userAgent;
            const isCrawler = /facebookexternalhit|Twitterbot|LinkedInBot|Googlebot|bingbot/i.test(userAgent);

            // If it's a crawler, don't redirect - serve index.html with OG meta tags
            if (isCrawler) {
                console.log('Crawler detected - serving index.html with OG meta tags');
                return;
            }

            // For regular users, initialize audio system and run the intro loader first, then redirect.
            try {
                // STEP 1: Import and initialize the audio state manager for intro loader sounds
                const audioStateModule = await import('./js/audioStateManager.js?v=11.0.12');
                const audioStateManager = audioStateModule.default;
                audioStateManager.init();
                console.log('[index.html] Audio state manager initialized');

                // STEP 2: Import and initialize the intro loader
                const introLoaderModule = await import('./js/intro-loader.js?v=11.0.12');
                const introLoader = introLoaderModule.default;

                // STEP 3: Initialize and display the intro loader UI.
                // This happens immediately on page load.
                console.log('[index.html] Initializing intro loader...');
                introLoader.init();

                // STEP 4: Wait for the loader's hide() promise to resolve.
                // This promise handles user clicks, minimum display time, and fade-out animations.
                console.log('[index.html] Waiting for intro loader to complete...');
                await introLoader.hide();

                // STEP 5: Now that the loader is finished, redirect to clean URL /chat
                // Device detection will happen in Cloud Function, not here
                console.log('[index.html] Intro complete, redirecting to /chat...');
                const search = window.location.search;
                const hash = window.location.hash;
                const finalUrl = `./chat${search}${hash}`;
                window.location.replace(finalUrl);
            } catch (error) {
                console.error('Device detection or intro loader failed:', error);
                window.location.replace('./chat' + window.location.search + window.location.hash);
            }
        }
    </script>

</body>
</html>
