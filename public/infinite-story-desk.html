<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="./js/clean-url.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reconciliation Story - Moon Tide</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75'>ðŸŒŠ</text></svg>">
    <link rel="stylesheet" href="./libs/fontawesome/all.min.css">
    <link rel="stylesheet" href="./css/infinite-story-desk.css">
    <!-- CRITICAL FIX: Hide body content until spiral loader covers it -->
    <style>
        body {
            opacity: 0;
            transition: opacity 0.1s ease;
        }
        body.loader-ready {
            opacity: 1;
        }
    </style>
    <script src="./js/audioStateManager.js" type="module"></script>
    <script src="./js/audioPermissionUI.js" type="module"></script>
    <script src="./js/soundManager.js" type="module"></script>
    <script src="./js/tts-manager.js" type="module"></script>
</head>
<body>
    <!-- Ambient particle background -->
    <div class="story-ambient-bg">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>

    <!-- Header with exit button -->
    <header class="story-header">
        <button class="story-exit-btn" id="exitStoryBtn" title="Return to Moon Tide (ESC)">
            <i class="fas fa-arrow-left"></i>
        </button>
        <h1 id="headerTitle">The Reconciliation Journey</h1>
        <div class="chapter-badge" id="chapterBadge">1</div>
    </header>

    <!-- Image box on the right -->
    <div class="story-image-container">
        <div class="story-image-box">
            <img src="./images/webp/moon9.webp" alt="Moon Tide" class="story-moon-image">
            <div class="image-glow"></div>
        </div>

        <!-- Story Control Buttons -->
        <div class="story-control-buttons">
            <button class="story-control-btn story-new-btn" id="newStoryBtn" title="Start a new story">
                <span>ðŸ“–</span>
                <span>New Story</span>
            </button>
            <button class="story-control-btn story-voice-btn story-voice-btn-active" id="maleVoiceBtn" data-voice="en-US-Studio-M" title="Male Voice (Default)">
                <span>ðŸ§‘</span>
                <span>Male Voice</span>
            </button>
            <button class="story-control-btn story-voice-btn" id="femaleVoiceBtn" data-voice="en-US-Studio-O" title="Female Voice">
                <span>ðŸ‘©</span>
                <span>Female Voice</span>
            </button>
        </div>
    </div>

    <!-- Main centered story content -->
    <main class="story-main-container">

        <!-- Prologue Box -->
        <div class="story-prologue-box" id="prologueBox">
            <div class="prologue-icon">ðŸ“–</div>
            <div class="prologue-content" id="prologueContent">
                <p>Loading your story...</p>
            </div>
        </div>

        <!-- Centered story content area -->
        <div class="story-content-wrapper">

            <!-- Narrative Section -->
            <div class="story-narrative-section">
                <div class="narrative-scroll-container" id="narrativeScrollContainer">
                    <div class="narrative-text" id="narrativeText">
                        <p>Loading narrative...</p>
                    </div>
                </div>

                <!-- TTS Control for Narrative -->
                <div class="story-tts-control">
                    <button class="tts-button" id="narrativeTTSButton" title="Listen to this chapter">
                        <i class="fas fa-volume-up"></i>
                        <span>Listen to Story</span>
                    </button>
                </div>
            </div>

            <!-- Choices Section -->
            <div class="story-choices-section" id="choicesSection">
                <div class="choices-header">
                    <h3>Your Choices Shape the Journey</h3>
                    <p class="choices-hint">Press the number key or click to select</p>
                </div>

                <div class="choices-container" id="choicesContainer">
                    <!-- Choices inserted dynamically here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Hidden audio player for TTS -->
    <audio id="ttsPlayer" style="display: none;"></audio>

    <!-- Main Story Controller Script -->
    <script type="module">
        import soundManager from './js/soundManager.js';
        import ttsManager from './js/tts-manager.js';
        import audioStateManager from './js/audioStateManager.js';
        import audioPermissionUI from './js/audioPermissionUI.js';
        import SpiralLoader from './js/spiral-loader.js';

        // Initialize spiral loader (shows on page load)
        const spiralLoader = new SpiralLoader({ particleCount: 12, orbitRadius: 80, lapDuration: 3 });
        spiralLoader.init();
        spiralLoader.show();

        // Make body visible now that spiral loader is covering it
        document.body.classList.add('loader-ready');

        // Initialize audio state manager
        audioStateManager.init();
        audioPermissionUI.init();

        // Make ttsManager globally available and initialize it
        window.ttsManager = ttsManager;
        const ttsPlayer = document.getElementById('ttsPlayer');
        ttsManager.init(ttsPlayer, null, () => {
            console.log('[TTS] TTS manager initialized and ready');
        });

        // Listen for audio playback completion to update button states
        ttsPlayer.addEventListener('ended', () => {
            console.log('[Story TTS] Audio playback completed');
            updateStoryTTSButtonStates();
        });

        // Voice selection state (default: male voice)
        let selectedVoice = 'en-US-Studio-M';

        // Setup story control buttons
        function setupStoryControlButtons() {
            // New Story button - refresh page
            const newStoryBtn = document.getElementById('newStoryBtn');
            if (newStoryBtn) {
                newStoryBtn.addEventListener('click', () => {
                    console.log('[Story] Starting new story...');
                    location.reload();
                });
            }

            // Voice selection buttons
            const maleVoiceBtn = document.getElementById('maleVoiceBtn');
            const femaleVoiceBtn = document.getElementById('femaleVoiceBtn');

            if (maleVoiceBtn) {
                maleVoiceBtn.addEventListener('click', () => {
                    console.log('[Story] Selected Male Voice');
                    selectedVoice = 'en-US-Studio-M';
                    maleVoiceBtn.classList.add('story-voice-btn-active');
                    femaleVoiceBtn.classList.remove('story-voice-btn-active');
                });
            }

            if (femaleVoiceBtn) {
                femaleVoiceBtn.addEventListener('click', () => {
                    console.log('[Story] Selected Female Voice');
                    selectedVoice = 'en-US-Studio-O';
                    femaleVoiceBtn.classList.add('story-voice-btn-active');
                    maleVoiceBtn.classList.remove('story-voice-btn-active');
                });
            }

            // Set male voice as default (add active class)
            if (maleVoiceBtn && !maleVoiceBtn.classList.contains('story-voice-btn-active')) {
                maleVoiceBtn.classList.add('story-voice-btn-active');
            }
        }

        // Get or create session ID
        function getSessionId() {
            let sessionId = sessionStorage.getItem('moon_tide_session_id');
            if (!sessionId) {
                sessionId = `session_${crypto.randomUUID()}`;
                sessionStorage.setItem('moon_tide_session_id', sessionId);
            }
            return sessionId;
        }

        // Get device fingerprint
        async function getFingerprint() {
            try {
                const response = await fetch('https://reconciliation-backend-934410532991.us-central1.run.app/sign-fingerprint', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        device_fingerprint: `desktop_${window.innerWidth}x${window.innerHeight}_${window.devicePixelRatio}`,
                        fingerprint_timestamp: Math.floor(Date.now() / 1000).toString()
                    })
                });
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Failed to get fingerprint:', error);
                return null;
            }
        }

        // Initialize story on page load
        async function initStory() {
            const sessionId = getSessionId();
            const fingerprint = await getFingerprint();

            if (!fingerprint) {
                console.error('Failed to initialize fingerprint');
                return;
            }

            sendStoryCommand('[START_STORY]', sessionId, fingerprint);
        }

        // Send command to backend
        async function sendStoryCommand(command, sessionId, fingerprint) {
            spiralLoader.show();

            try {
                const response = await fetch('https://reconciliation-backend-934410532991.us-central1.run.app/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: command,
                        session_id: sessionId,
                        device_fingerprint: fingerprint.device_fingerprint,
                        fingerprint_signature: fingerprint.signature,
                        fingerprint_timestamp: fingerprint.timestamp,
                        voice: selectedVoice
                    })
                });

                const data = await response.json();

                if (data.action && data.action.type === 'SHOW_RECONCILIATION_STORY') {
                    await renderStory(data.action.payload, sessionId, fingerprint);
                }
            } catch (error) {
                console.error('Error fetching story:', error);
                spiralLoader.hide(100);
            }
        }

        // Render story content
        async function renderStory(storyData, sessionId, fingerprint) {
            // Scroll to top of page
            window.scrollTo(0, 0);

            // Update header title with saga
            document.getElementById('headerTitle').textContent = storyData.saga_title || 'The Reconciliation Journey';

            // Update prologue
            document.getElementById('prologueContent').innerHTML =
                `<p>${(storyData.world_concept || '').replace(/\n/g, '<br>')}</p>`;

            // Update narrative
            document.getElementById('narrativeText').innerHTML =
                `<p>${(storyData.narrative || '').replace(/\n/g, '<br>')}</p>`;

            // Clear and populate choices
            const choicesContainer = document.getElementById('choicesContainer');
            choicesContainer.innerHTML = '';

            if (storyData.choices && Array.isArray(storyData.choices)) {
                storyData.choices.forEach((choice, index) => {
                    const choiceNum = index + 1;
                    const choiceEl = document.createElement('div');
                    choiceEl.className = 'choice-item';
                    choiceEl.dataset.choice = choiceNum;
                    choiceEl.innerHTML = `
                        <div class="choice-number">${choiceNum}</div>
                        <div class="choice-content">
                            <p class="choice-text">${choice}</p>
                            <button class="choice-tts-btn" data-text="${choice}" title="Listen to this choice">
                                <i class="fas fa-volume-up"></i>
                            </button>
                        </div>
                    `;

                    choiceEl.addEventListener('click', (e) => {
                        e.stopPropagation();
                        selectChoice(choice, sessionId, fingerprint);
                    });

                    // Setup TTS for choice - use real two-click unlock system
                    const choiceTtsBtn = choiceEl.querySelector('.choice-tts-btn');
                    if (choiceTtsBtn) {
                        // Initialize button state
                        if (ttsManager.ttsUnlockedForSession) {
                            choiceTtsBtn.querySelector('i').className = 'fas fa-play';
                            choiceTtsBtn.title = 'Play';
                        } else {
                            choiceTtsBtn.querySelector('i').className = 'fas fa-volume-mute';
                            choiceTtsBtn.title = 'Click to unlock TTS';
                        }

                        choiceTtsBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            e.preventDefault();
                            handleTTSButtonClick(choice, choiceTtsBtn);
                        });
                    }

                    choicesContainer.appendChild(choiceEl);
                });
            }

            // Setup TTS for narrative
            const ttsBtn = document.getElementById('narrativeTTSButton');

            // Initialize button state
            if (ttsManager.ttsUnlockedForSession) {
                ttsBtn.querySelector('i').className = 'fas fa-play';
                ttsBtn.title = 'Play';
            } else {
                ttsBtn.querySelector('i').className = 'fas fa-volume-mute';
                ttsBtn.title = 'Click to unlock TTS';
            }

            // Clear old listeners by cloning
            const newTtsBtn = ttsBtn.cloneNode(true);
            ttsBtn.parentNode.replaceChild(newTtsBtn, ttsBtn);

            // Add new listener
            newTtsBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                handleTTSButtonClick(storyData.narrative, newTtsBtn);
            });

            // Setup keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    window.location.href = '/menu';
                }
                if (e.key === '1' || e.key === '2' || e.key === '3') {
                    const choiceNum = parseInt(e.key);
                    const choice = storyData.choices[choiceNum - 1];
                    if (choice) {
                        selectChoice(choice, sessionId, fingerprint);
                    }
                }
            });

            // Store current story data
            window.currentStoryData = storyData;
            window.currentSessionId = sessionId;
            window.currentFingerprint = fingerprint;

            // Now that all rendering is complete, fade out the loading screen
            await spiralLoader.complete();
        }

        // Select a choice
        async function selectChoice(choiceText, sessionId, fingerprint) {
            spiralLoader.show();

            try {
                const response = await fetch('https://reconciliation-backend-934410532991.us-central1.run.app/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: `[CHOICE] ${choiceText}`,
                        session_id: sessionId,
                        device_fingerprint: fingerprint.device_fingerprint,
                        fingerprint_signature: fingerprint.signature,
                        fingerprint_timestamp: fingerprint.timestamp,
                        voice: selectedVoice
                    })
                });

                const data = await response.json();
                if (data.action && data.action.type === 'SHOW_RECONCILIATION_STORY') {
                    const chapterNum = parseInt(document.getElementById('chapterBadge').textContent);
                    document.getElementById('chapterBadge').textContent = chapterNum + 1;
                    await renderStory(data.action.payload, sessionId, fingerprint);
                }
            } catch (error) {
                console.error('Error selecting choice:', error);
                await spiralLoader.hide(100);
            }
        }

        // Get audio from backend with voice selection
        async function getAudioWithVoice(text, backendUrl, voice) {
            try {
                const response = await fetch(`${backendUrl}/tts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: text,
                        voice: voice
                    })
                });

                if (!response.ok) {
                    console.error('[Story TTS] Failed to fetch audio:', response.status);
                    return null;
                }

                const data = await response.json();
                return data.audio || null;
            } catch (error) {
                console.error('[Story TTS] Error getting audio from backend:', error);
                return null;
            }
        }

        // Handle TTS button click - two-step process matching portal-controller.js
        async function handleTTSButtonClick(text, buttonElement) {
            const icon = buttonElement.querySelector('i');
            const isLocked = icon.classList.contains('fa-volume-mute');

            // FIRST CLICK: If locked, unlock only - DON'T play yet
            if (isLocked) {
                console.log('[Story TTS] First click - attempting to unlock TTS...');
                const unlocked = await ttsManager.attemptTTSUnlock();
                if (!unlocked) {
                    console.log('[Story TTS] Unlock failed - button stays locked');
                    return;
                }
                console.log('[Story TTS] TTS unlocked! Updating buttons to play icon.');
                updateStoryTTSButtonStates();
                return; // STOP HERE - user must click again to play
            }

            // SECOND CLICK: If already unlocked (showing play icon), play audio
            if (ttsManager.isPlaying) {
                ttsManager.stop();
                updateStoryTTSButtonStates();
                return;
            }

            icon.className = 'fas fa-spinner fa-spin';
            buttonElement.disabled = true;

            try {
                // Get audio with the selected voice
                const backendUrl = 'https://reconciliation-backend-934410532991.us-central1.run.app';
                const audioBase64 = await getAudioWithVoice(text, backendUrl, selectedVoice);
                if (audioBase64) {
                    ttsManager.play(audioBase64);
                    updateStoryTTSButtonStates(text);
                } else {
                    resetStoryTTSButton(buttonElement);
                }
            } catch (error) {
                console.error('[Story TTS] Error fetching audio:', error);
                resetStoryTTSButton(buttonElement);
            }
        }

        // Reset TTS button to play state
        function resetStoryTTSButton(buttonElement) {
            const icon = buttonElement.querySelector('i');
            icon.className = 'fas fa-play';
            buttonElement.disabled = false;
        }

        // Update all TTS button states (called after unlock or during playback)
        function updateStoryTTSButtonStates(currentPlayingText = null) {
            // Update narrative TTS button
            const narrativeTTSBtn = document.getElementById('narrativeTTSButton');
            if (narrativeTTSBtn) {
                const icon = narrativeTTSBtn.querySelector('i');
                narrativeTTSBtn.disabled = false;

                if (currentPlayingText === window.currentStoryData?.narrative && ttsManager.isPlaying) {
                    icon.className = 'fas fa-stop';
                    narrativeTTSBtn.title = 'Stop';
                } else {
                    icon.className = ttsManager.ttsUnlockedForSession ? 'fas fa-play' : 'fas fa-volume-mute';
                    narrativeTTSBtn.title = ttsManager.ttsUnlockedForSession ? 'Play' : 'Click to unlock TTS';
                }
            }

            // Update all choice TTS buttons
            document.querySelectorAll('.choice-tts-btn').forEach(btn => {
                const choiceText = btn.getAttribute('data-text');
                const icon = btn.querySelector('i');
                btn.disabled = false;

                if (choiceText === currentPlayingText && ttsManager.isPlaying) {
                    icon.className = 'fas fa-stop';
                    btn.title = 'Stop';
                } else {
                    icon.className = ttsManager.ttsUnlockedForSession ? 'fas fa-play' : 'fas fa-volume-mute';
                    btn.title = ttsManager.ttsUnlockedForSession ? 'Play' : 'Click to unlock TTS';
                }
            });
        }

        // Exit button
        document.getElementById('exitStoryBtn').addEventListener('click', () => {
            window.location.href = '/menu';
        });

        // Initialize when page loads
        window.addEventListener('load', () => {
            setupStoryControlButtons();
            initStory();
        });
    </script>
</body>
</html>
