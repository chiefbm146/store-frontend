================================================================================
                     MOON TIDE PAYMENT DATA FLOW
         How Name, Email, Phone, and Card Data Move Through System
================================================================================

1. USER ENTERS DATA IN CHECKOUT FORM
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Frontend Checkout (stripe-checkout.js)                      â”‚
   â”‚                                                               â”‚
   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
   â”‚  â”‚ USER FILLS THESE FIELDS:                             â”‚   â”‚
   â”‚  â”‚                                                       â”‚   â”‚
   â”‚  â”‚ [ John Doe                    ]  â† customer-name     â”‚   â”‚
   â”‚  â”‚ [ john@example.com            ]  â† customer-email    â”‚   â”‚
   â”‚  â”‚ [ +1-555-1234                 ]  â† customer-phone    â”‚   â”‚
   â”‚  â”‚                                                       â”‚   â”‚
   â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
   â”‚  â”‚ â”‚ Stripe Card Element                            â”‚  â”‚   â”‚
   â”‚  â”‚ â”‚ (Renders secure card input)                    â”‚  â”‚   â”‚
   â”‚  â”‚ â”‚                                                 â”‚  â”‚   â”‚
   â”‚  â”‚ â”‚ Card Number:   [ 4242 4242 4242 4242 ]        â”‚  â”‚   â”‚
   â”‚  â”‚ â”‚ Exp Date:      [ 12 / 25 ]                    â”‚  â”‚   â”‚
   â”‚  â”‚ â”‚ CVC:           [ 123 ]                        â”‚  â”‚   â”‚
   â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
   â”‚  â”‚ (Handled 100% by Stripe, never sent to backend)      â”‚   â”‚
   â”‚  â”‚                                                       â”‚   â”‚
   â”‚  â”‚ [âœ“] I agree to terms and privacy policy            â”‚   â”‚
   â”‚  â”‚                                                       â”‚   â”‚
   â”‚  â”‚ [ PAY $100.00 ]  Button enabled when all fields OK  â”‚   â”‚
   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ USER CLICKS "PAY $100.00"
                         â”‚
                         â†“


2. STRIPE PROCESSES THE CARD (BROWSER)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Stripe.js (In Browser)                                      â”‚
   â”‚                                                               â”‚
   â”‚  stripe.confirmCardPayment(clientSecret, {                  â”‚
   â”‚    payment_method: {                                        â”‚
   â”‚      card: cardElement,        â† Card from Stripe Element  â”‚
   â”‚      billing_details: {                                    â”‚
   â”‚        name: "John Doe",       â† From customer-name field  â”‚
   â”‚        email: "john@...",      â† From customer-email field â”‚
   â”‚        phone: "+1-555-1234"    â† From customer-phone field â”‚
   â”‚      }                                                       â”‚
   â”‚    }                                                         â”‚
   â”‚  })                                                          â”‚
   â”‚                                                               â”‚
   â”‚  âœ… Stripe validates card                                   â”‚
   â”‚  âœ… Stripe processes payment                                â”‚
   â”‚  âœ… Returns PaymentIntent status                            â”‚
   â”‚                                                               â”‚
   â”‚  Response:                                                   â”‚
   â”‚  {                                                           â”‚
   â”‚    paymentIntent: {                                         â”‚
   â”‚      id: "pi_xxxxx",                                       â”‚
   â”‚      status: "succeeded",                                  â”‚
   â”‚      client_secret: "pi_xxxxx_secret_yyyyy"               â”‚
   â”‚    }                                                        â”‚
   â”‚  }                                                           â”‚
   â”‚                                                               â”‚
   â”‚  âš ï¸ IMPORTANT:                                              â”‚
   â”‚  â€¢ Raw card number NEVER leaves Stripe Element             â”‚
   â”‚  â€¢ Stripe tokenizes and processes                          â”‚
   â”‚  â€¢ Frontend receives ONLY payment status                   â”‚
   â”‚                                                               â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ Payment succeeded in Stripe
                         â”‚ Now collect full transaction details
                         â”‚
                         â†“


3. FRONTEND CALLS BACKEND ORCHESTRATOR
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Frontend â†’ Backend API Call                                 â”‚
   â”‚                                                               â”‚
   â”‚  POST /record-and-distribute-transaction                    â”‚
   â”‚                                                               â”‚
   â”‚  Request Body:                                              â”‚
   â”‚  {                                                           â”‚
   â”‚    "stripePaymentId": "pi_xxxxx",         â† From Stripe    â”‚
   â”‚    "name": "John Doe",                    â† From form      â”‚
   â”‚    "email": "john@example.com",           â† From form      â”‚
   â”‚    "phone": "+1-555-1234",                â† From form      â”‚
   â”‚    "items": [                             â† Cart items     â”‚
   â”‚      {                                                      â”‚
   â”‚        "id": "shirts-1",                                   â”‚
   â”‚        "name": "Shirt #1",                                â”‚
   â”‚        "price": 29.99,                                     â”‚
   â”‚        "quantity": 2                                       â”‚
   â”‚      }                                                      â”‚
   â”‚    ],                                                       â”‚
   â”‚    "workshopId": "cedar-basket",          â† Selected      â”‚
   â”‚    "workshopDetails": {                                    â”‚
   â”‚      "workshop_name": "Cedar Basket...",                  â”‚
   â”‚      "organization_type": "community",                    â”‚
   â”‚      "participants": 15,                                  â”‚
   â”‚      "requested_date": "2025-12-15",                      â”‚
   â”‚      "requested_time": "10:00 AM"                         â”‚
   â”‚    }                                                        â”‚
   â”‚  }                                                           â”‚
   â”‚                                                               â”‚
   â”‚  âš ï¸ IMPORTANT:                                              â”‚
   â”‚  â€¢ Name, email, phone sent unencrypted in JSON            â”‚
   â”‚  â€¢ But connection is HTTPS (encrypted in transit)         â”‚
   â”‚  â€¢ Backend stores to database                              â”‚
   â”‚                                                               â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ HTTPS Request (encrypted)
                         â”‚
                         â†“


4. BACKEND RETRIEVES FULL TRANSACTION FROM STRIPE
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Backend (main.py)                                           â”‚
   â”‚                                                               â”‚
   â”‚  STEP 1: Fetch PaymentIntent from Stripe                   â”‚
   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                 â”‚
   â”‚                                                               â”‚
   â”‚  pi = stripe.PaymentIntent.retrieve(                       â”‚
   â”‚    pi_id,                                                  â”‚
   â”‚    expand=['latest_charge.balance_transaction']            â”‚
   â”‚  )                                                           â”‚
   â”‚                                                               â”‚
   â”‚  Returns:                                                    â”‚
   â”‚  {                                                           â”‚
   â”‚    id: "pi_xxxxx",                                         â”‚
   â”‚    amount: 10000,                      â† Cents ($100.00)   â”‚
   â”‚    currency: "cad",                                        â”‚
   â”‚    status: "succeeded",                                   â”‚
   â”‚    latest_charge: {                                        â”‚
   â”‚      id: "ch_xxxxx",                                      â”‚
   â”‚      amount: 10000,                                        â”‚
   â”‚      balance_transaction: {                               â”‚
   â”‚        fee: 320,                   â† Stripe's fee: $3.20  â”‚
   â”‚        net: 9680                   â† Net to franchisee    â”‚
   â”‚      }                                                      â”‚
   â”‚    }                                                        â”‚
   â”‚  }                                                           â”‚
   â”‚                                                               â”‚
   â”‚  âš ï¸ IMPORTANT:                                              â”‚
   â”‚  â€¢ Backend fetches ALL transaction details from Stripe    â”‚
   â”‚  â€¢ Stripe is the SOURCE OF TRUTH for fees                â”‚
   â”‚  â€¢ Backend never has access to raw card number            â”‚
   â”‚                                                               â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ Calculate financial breakdown
                         â”‚
                         â†“


5. BACKEND CALCULATES FEES
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Backend Calculations                                        â”‚
   â”‚                                                               â”‚
   â”‚  From Stripe PaymentIntent:                                â”‚
   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                              â”‚
   â”‚  total_amount = 10000          ($100.00)                   â”‚
   â”‚  stripe_fee = 320              ($3.20 from balance_txn)   â”‚
   â”‚  platform_fee = 290            ($2.90 = 2.9% of total)    â”‚
   â”‚  franchisee_net = 9680 - 290 = 9390  ($93.90)             â”‚
   â”‚                                                               â”‚
   â”‚  FINANCIAL BREAKDOWN:                                       â”‚
   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                               â”‚
   â”‚  Customer pays:      $100.00                               â”‚
   â”‚  - Stripe fee:       $3.20    (2.9% + $0.30)             â”‚
   â”‚  - Platform fee:     $2.90    (2.9%)                      â”‚
   â”‚  = Franchisee gets:  $93.90                               â”‚
   â”‚                                                               â”‚
   â”‚  These values stored in "Golden Record"                    â”‚
   â”‚                                                               â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ Construct Golden Record
                         â”‚
                         â†“


6. BACKEND CONSTRUCTS "GOLDEN RECORD"
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  The Single Source of Truth                                  â”‚
   â”‚                                                               â”‚
   â”‚  golden_record = {                                          â”‚
   â”‚                                                               â”‚
   â”‚    /* Customer PII from frontend form */                   â”‚
   â”‚    "name": "John Doe",                                     â”‚
   â”‚    "email": "john@example.com",                            â”‚
   â”‚    "phone": "+1-555-1234",                                 â”‚
   â”‚                                                               â”‚
   â”‚    /* Order details from frontend */                       â”‚
   â”‚    "stripePaymentId": "pi_xxxxx",                          â”‚
   â”‚    "items": [{...}],                                       â”‚
   â”‚    "workshopId": "cedar-basket",                           â”‚
   â”‚    "workshopDetails": {...},                               â”‚
   â”‚                                                               â”‚
   â”‚    /* Financial breakdown (from Stripe) */                 â”‚
   â”‚    "amount_total": 10000,      ($100.00)                   â”‚
   â”‚    "amount_stripe_fee": 320,   ($3.20)                     â”‚
   â”‚    "amount_platform_fee": 290, ($2.90)                     â”‚
   â”‚    "amount_franchisee_net": 9390, ($93.90)                 â”‚
   â”‚                                                               â”‚
   â”‚    /* Metadata */                                            â”‚
   â”‚    "currency": "cad",                                       â”‚
   â”‚    "status": "succeeded",                                   â”‚
   â”‚    "timestamp": "2025-11-22T15:30:00Z"                     â”‚
   â”‚  }                                                            â”‚
   â”‚                                                               â”‚
   â”‚  This is stored in TWO places:                             â”‚
   â”‚  1. MOON Firestore (backup)                               â”‚
   â”‚  2. Portal Firestore (primary ledger)                     â”‚
   â”‚                                                               â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ Write to databases
                         â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                     â”‚
              â†“                     â†“


7. DATA STORED IN TWO FIRESTORES
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   MOON Firestore (Backup)  â”‚   â”‚ Portal Firestore (Primary) â”‚
   â”‚   reconciliation-475704    â”‚   â”‚ stripe-connect-1029120000  â”‚
   â”‚                            â”‚   â”‚                            â”‚
   â”‚  Collection: customers     â”‚   â”‚ Collection: franchisees    â”‚
   â”‚  Document: pi_xxxxx        â”‚   â”‚ Document: fwUTB.../{ID}    â”‚
   â”‚                            â”‚   â”‚ Sub-coll: transactions     â”‚
   â”‚  {                         â”‚   â”‚                            â”‚
   â”‚    name: "John Doe"        â”‚   â”‚ {                          â”‚
   â”‚    email: "john@..."       â”‚   â”‚   name: "John Doe"         â”‚
   â”‚    phone: "+1-555-1234"    â”‚   â”‚   email: "john@..."        â”‚
   â”‚    stripePaymentId: "pi_"  â”‚   â”‚   phone: "+1-555-1234"     â”‚
   â”‚    items: [...]            â”‚   â”‚   stripePaymentId: "pi_"   â”‚
   â”‚    workshopId: "cedar-"    â”‚   â”‚   items: [...]             â”‚
   â”‚    amount_total: 10000     â”‚   â”‚   workshopId: "cedar-"     â”‚
   â”‚    amount_stripe_fee: 320  â”‚   â”‚   amount_total: 10000      â”‚
   â”‚    amount_platform_fee:290 â”‚   â”‚   amount_stripe_fee: 320   â”‚
   â”‚    amount_franchisee_net:  â”‚   â”‚   amount_platform_fee:290  â”‚
   â”‚      9390                  â”‚   â”‚   amount_franchisee_net:   â”‚
   â”‚    currency: "cad"         â”‚   â”‚     9390                   â”‚
   â”‚    status: "succeeded"     â”‚   â”‚   currency: "cad"          â”‚
   â”‚    timestamp: "2025-11"    â”‚   â”‚   status: "succeeded"      â”‚
   â”‚  }                         â”‚   â”‚   timestamp: "2025-11"     â”‚
   â”‚                            â”‚   â”‚ }                          â”‚
   â”‚  âœ“ Accessible by MOON team â”‚   â”‚ âœ“ Primary franchisee ledger
   â”‚  âœ“ Backup record           â”‚   â”‚ âœ“ Used for accounting      â”‚
   â”‚  âœ“ All transaction history â”‚   â”‚ âœ“ 2% fee tracking          â”‚
   â”‚                            â”‚   â”‚                            â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


8. WHAT WAS STORED WHERE: SUMMARY
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Data                   â”‚  Stored in MOON? â”‚ Stored in Portal? â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚  Customer name          â”‚      âœ“ YES       â”‚      âœ“ YES        â”‚
   â”‚  Customer email         â”‚      âœ“ YES       â”‚      âœ“ YES        â”‚
   â”‚  Customer phone         â”‚      âœ“ YES       â”‚      âœ“ YES        â”‚
   â”‚  Stripe Payment ID      â”‚      âœ“ YES       â”‚      âœ“ YES        â”‚
   â”‚  Workshop details       â”‚      âœ“ YES       â”‚      âœ“ YES        â”‚
   â”‚  Product items          â”‚      âœ“ YES       â”‚      âœ“ YES        â”‚
   â”‚  Amount total           â”‚      âœ“ YES       â”‚      âœ“ YES        â”‚
   â”‚  Stripe fee             â”‚      âœ“ YES       â”‚      âœ“ YES        â”‚
   â”‚  Platform fee           â”‚      âœ“ YES       â”‚      âœ“ YES        â”‚
   â”‚  Franchisee net amount  â”‚      âœ“ YES       â”‚      âœ“ YES        â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚  Raw card number        â”‚      âœ— NO        â”‚      âœ— NO         â”‚
   â”‚  Card expiry date       â”‚      âœ— NO        â”‚      âœ— NO         â”‚
   â”‚  Card CVC               â”‚      âœ— NO        â”‚      âœ— NO         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


9. DATA FLOW TIMELINE
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  T+0s  â”‚ User enters: Name, Email, Phone, Card               â”‚
   â”‚        â”‚                                                       â”‚
   â”‚  T+1s  â”‚ User clicks "Pay $100.00"                           â”‚
   â”‚        â”‚ Frontend calls: stripe.confirmCardPayment()        â”‚
   â”‚        â”‚                                                       â”‚
   â”‚  T+2s  â”‚ Stripe processes card (securely in Stripe servers) â”‚
   â”‚        â”‚ Returns: PaymentIntent with status=succeeded       â”‚
   â”‚        â”‚ âš ï¸ Card data STAYS in Stripe                      â”‚
   â”‚        â”‚                                                       â”‚
   â”‚  T+3s  â”‚ Frontend calls: /record-and-distribute-transaction â”‚
   â”‚        â”‚ Sends: name, email, phone, paymentId, items       â”‚
   â”‚        â”‚ âš ï¸ These sent via HTTPS (encrypted)               â”‚
   â”‚        â”‚                                                       â”‚
   â”‚  T+4s  â”‚ Backend fetches full transaction from Stripe      â”‚
   â”‚        â”‚ Gets: Amount, fees, status, charge details        â”‚
   â”‚        â”‚                                                       â”‚
   â”‚  T+5s  â”‚ Backend calculates fees & constructs Golden Recordâ”‚
   â”‚        â”‚                                                       â”‚
   â”‚  T+6s  â”‚ Backend writes Golden Record to MOON Firestore    â”‚
   â”‚        â”‚ âœ“ Backup stored                                   â”‚
   â”‚        â”‚                                                       â”‚
   â”‚  T+7s  â”‚ Backend writes Golden Record to Portal Firestore  â”‚
   â”‚        â”‚ âœ“ Primary ledger stored                           â”‚
   â”‚        â”‚                                                       â”‚
   â”‚  T+8s  â”‚ Frontend receives success response                 â”‚
   â”‚        â”‚ Shows: "Payment Successful!"                       â”‚
   â”‚        â”‚ User receives confirmation email                   â”‚
   â”‚        â”‚                                                       â”‚
   â”‚ DONE   â”‚ Complete transaction recorded in both Firestores  â”‚
   â”‚        â”‚ Franchisee can see transaction in Portal          â”‚
   â”‚        â”‚ MOON team has backup record                       â”‚
   â”‚                                                               â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


10. KEY SECURITY POINTS
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                                â”‚
    â”‚  âœ… SECURE - We handle correctly:                             â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”‚
    â”‚  â€¢ Card data never touches backend (Stripe handles)          â”‚
    â”‚  â€¢ HTTPS encryption for all data in transit                  â”‚
    â”‚  â€¢ Firestore encryption at rest                              â”‚
    â”‚  â€¢ PCI-DSS compliant (Stripe certification)                  â”‚
    â”‚  â€¢ Rate limiting on payment endpoints                        â”‚
    â”‚  â€¢ Session tokens with HMAC-SHA256 validation                â”‚
    â”‚                                                                â”‚
    â”‚  âš ï¸  SENSITIVE DATA - Handle carefully:                       â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                      â”‚
    â”‚  â€¢ Customer names in Firestore (semi-PII)                    â”‚
    â”‚  â€¢ Customer emails in Firestore (PII)                        â”‚
    â”‚  â€¢ Customer phone numbers in Firestore (PII)                 â”‚
    â”‚  â€¢ Transaction amounts visible to franchisees                â”‚
    â”‚                                                                â”‚
    â”‚  ğŸ”’ Best practices:                                            â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                           â”‚
    â”‚  â€¢ Use Firestore security rules (restrict access)            â”‚
    â”‚  â€¢ Enable audit logging                                      â”‚
    â”‚  â€¢ Backup Firestore regularly                                â”‚
    â”‚  â€¢ Rotate API secrets quarterly                              â”‚
    â”‚  â€¢ Use HTTPS only (no HTTP)                                  â”‚
    â”‚  â€¢ Keep Stripe libraries updated                             â”‚
    â”‚                                                                â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

================================================================================

QUICK REFERENCE: "WHERE IS MY DATA?"

Customer's Name:
  âœ“ Frontend form input
  âœ“ Sent to Stripe (billing_details)
  âœ“ Sent to backend (/record-and-distribute-transaction)
  âœ“ Stored in MOON Firestore
  âœ“ Stored in Portal Firestore

Customer's Email:
  âœ“ Frontend form input
  âœ“ Sent to Stripe (billing_details)
  âœ“ Sent to backend (/record-and-distribute-transaction)
  âœ“ Stored in MOON Firestore
  âœ“ Stored in Portal Firestore

Customer's Phone:
  âœ“ Frontend form input
  âœ“ Sent to Stripe (billing_details)
  âœ“ Sent to backend (/record-and-distribute-transaction)
  âœ“ Stored in MOON Firestore
  âœ“ Stored in Portal Firestore

Customer's Card Number:
  âœ“ User types in Stripe Card Element
  âœ— NEVER sent to backend
  âœ— NEVER stored in Firestore
  âœ— NEVER logged by Moon Tide
  âœ“ Tokenized by Stripe only

Customer's Card Expiry:
  âœ“ User types in Stripe Card Element
  âœ— NEVER sent to backend
  âœ— NEVER stored in Firestore
  âœ— NEVER logged by Moon Tide
  âœ“ Tokenized by Stripe only

Customer's Card CVC:
  âœ“ User types in Stripe Card Element
  âœ— NEVER sent to backend
  âœ— NEVER stored in Firestore
  âœ— NEVER logged by Moon Tide
  âœ“ Tokenized by Stripe only (used once for payment)

================================================================================

Document Generated: November 22, 2025
For: MOON Tide Development Team
Status: COMPLETE