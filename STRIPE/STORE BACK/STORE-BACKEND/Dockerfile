FROM python:3.10-slim

# SECURITY: Create non-root user
RUN groupadd --gid 1000 appuser && \
    useradd --uid 1000 --gid appuser --shell /bin/bash --create-home appuser

WORKDIR /app

ENV PYTHONUNBUFFERED=1

COPY requirements.txt .
RUN pip install --upgrade pip
RUN pip install --no-cache-dir -r requirements.txt

# Copy the Stripe configuration file (generated by setup_stripe_and_deploy.py)
COPY stripe_config.json .

# Copy the application files to the root of /app
COPY main.py .
COPY tts_service.py .
COPY session_manager.py .
COPY security_monitor.py .
COPY story_engine.py .
COPY client_api.py .
COPY client_manager.py .
COPY stripe_connector.py .

# SECURITY: Change ownership to non-root user and switch user
RUN chown -R appuser:appuser /app
USER appuser

EXPOSE 8080

# Run the Flask app using Gunicorn with the flat structure
CMD ["gunicorn", "--worker-class", "gthread", "--bind", "0.0.0.0:8080", "--workers", "1", "--threads", "10", "--timeout", "300", "main:app"]