rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ========== ADMIN EMAIL CONSTANT ==========
    // Unified admin access for platform
    function isAdmin() {
      return request.auth != null &&
             request.auth.token.email == 'korypetersbm146@gmail.com';
    }

    // ========== FRANCHISEES COLLECTION ==========
    // Franchisees collection - only accessible to authenticated users managing their own account
    match /franchisees/{franchiseeId} {
      allow read, write: if request.auth.uid == franchiseeId;
      allow read: if isAdmin(); // Platform admin
    }

    // ========== FRANCHISEE PRODUCTS ==========
    // Products collection - franchisees can manage their own products
    match /franchisees/{franchiseeId}/products/{productId} {
      allow read, write: if request.auth.uid == franchiseeId;
      allow read: if isAdmin();
    }

    // ========== FRANCHISEE STRIPE ACCOUNT ==========
    // Stripe account details - secure, only franchisee owner can read
    match /franchisees/{franchiseeId}/stripe_account/{document=**} {
      allow read, write: if request.auth.uid == franchiseeId;
      allow read: if isAdmin();
    }

    // ========== FRANCHISEE TRANSACTIONS ==========
    // Transactions history - franchisees can view their own
    match /franchisees/{franchiseeId}/transactions/{transactionId} {
      allow read: if request.auth.uid == franchiseeId;
      allow read: if isAdmin();
      allow write: if request.auth == null; // Backend/webhooks write without auth
    }

    // ========== PUBLIC PRODUCTS ==========
    // Public products - for storefront viewing
    match /public_products/{document=**} {
      allow read: if true; // Anyone can view
      allow write: if false; // Only backend writes
    }

    // ========== DEFAULT: DENY ALL OTHER ACCESS ==========
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
